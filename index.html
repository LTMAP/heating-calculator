<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор теплого пола - Многокомнатный расчет</title>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #27ae60;
            --warning: #e74c3c;
            --light: #f5f7fa;
            --dark: #333;
            --gray: #e0e0e0;
            --text: #333;
            --text-light: #666;
            --white: #fff;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: var(--light);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        header {
            background: var(--secondary);
            color: var(--white);
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .calculator-content {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid var(--gray);
            border-radius: var(--border-radius);
            background: var(--white);
        }
        
        .step-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--secondary);
            display: flex;
            align-items: center;
        }
        
        .step-number {
            background: var(--primary);
            color: var(--white);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .option-card {
            border: 2px solid var(--gray);
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
        }
        
        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            border-color: var(--primary);
            background-color: #ebf5fb;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
        }
        
        .option-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .option-card p {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .power-info {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        
        .room-container {
            border: 1px solid var(--gray);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .room-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .remove-room {
            background: var(--warning);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .remove-room:hover {
            background: #c0392b;
        }
        
        .room-dimensions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .dimension {
            display: flex;
            flex-direction: column;
        }
        
        .dimension label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary);
        }
        
        .dimension input {
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 4px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .dimension input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .area-info {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            color: var(--secondary);
        }
        
        .add-room-btn {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-room-btn:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            transition: var(--transition);
        }
        
        .calculate-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .room-result {
            margin-bottom: 30px;
            border: 1px solid var(--gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--white);
        }
        
        .room-result-header {
            background: #34495e;
            color: var(--white);
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .room-result-content {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-card {
            border: 2px solid var(--accent);
            border-radius: var(--border-radius);
            padding: 20px;
            background-color: #f0fff4;
        }
        
        .result-card h4 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--secondary);
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .result-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .result-item strong {
            color: var(--secondary);
        }
        
        .layout-visualization {
            border: 1px solid var(--gray);
            border-radius: var(--border-radius);
            padding: 15px;
            background: var(--white);
        }
        
        .visualization-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: var(--secondary);
        }
        
        .visualization-container {
            width: 100%;
            height: 300px;
            border: 1px solid var(--gray);
            position: relative;
            background: #f9f9f9;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .room-outline {
            position: absolute;
            border: 2px solid var(--primary);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .section {
            position: absolute;
            border: 1px solid var(--warning);
            background: rgba(231, 76, 60, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #c0392b;
            overflow: hidden;
            flex-direction: column;
            transition: var(--transition);
        }
        
        .section:hover {
            background: rgba(231, 76, 60, 0.2);
            z-index: 10;
        }
        
        .section .sec-label {
            font-weight: bold;
        }
        
        .section .sec-size {
            font-size: 10px;
            color: #333;
        }
        
        .section.partial {
            background: rgba(243, 156, 18, 0.2);
            border-color: #f39c12;
        }
        
        .coverage-info {
            background: #e8f4f8;
            color: var(--secondary);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .warning {
            background: #fee;
            color: #c0392b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #c0392b;
        }
        
        .power-warning {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        
        .total-summary {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 1px solid var(--gray);
        }
        
        .total-summary h3 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--secondary);
            text-align: center;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }
        
        .summary-table th, .summary-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
        }
        
        .summary-table th {
            background: var(--secondary);
            color: var(--white);
            font-weight: bold;
        }
        
        .summary-table tr:last-child td {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
        }
        
        footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            color: var(--text-light);
            font-size: 14px;
            border-top: 1px solid var(--gray);
        }
        
        @media (max-width: 768px) {
            .room-result-content {
                grid-template-columns: 1fr;
            }
            
            .room-dimensions {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .calculator-content {
                padding: 20px;
            }
            
            .step {
                padding: 15px;
            }
            
            .summary-table {
                font-size: 14px;
            }
            
            .summary-table th, .summary-table td {
                padding: 8px 10px;
            }
        }
        
        .section-info {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-light);
        }
        
        .section-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .section-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .section-item:last-child {
            border-bottom: none;
        }
        
        .fallback-info {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            color: var(--secondary);
        }
        
        .min-power-info {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            font-size: 14px;
        }
        
        .coverage-success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <header>
            <h1>Калькулятор теплого пола - Многокомнатный расчет</h1>
            <p>Рассчитайте оптимальные модели для всех помещений вашего здания</p>
        </header>
        <div class="calculator-content">
            <div class="step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Оцените утепление помещения
                </div>
                <div class="options-grid" id="insulation-options">
                    <div class="option-card selected" data-value="low">
                        <h3>Низкое утепление</h3>
                        <p>Балкон, лоджия, старый дом</p>
                        <div class="power-info">Рекомендуемая мощность: от 200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="medium">
                        <h3>Среднее утепление</h3>
                        <p>Городская квартира</p>
                        <div class="power-info">Рекомендуемая мощность: 180-200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="high">
                        <h3>Высокое утепление</h3>
                        <p>Новостройка, утепленный дом</p>
                        <div class="power-info">Рекомендуемая мощность: 140-180 Вт/м²</div>
                    </div>
                </div>
            </div>
            <div class="step">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Добавьте помещения для расчета
                </div>
                <div id="rooms-container"></div>
                <button class="add-room-btn" id="add-room-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
                    </svg>
                    Добавить помещение
                </button>
            </div>
            <button class="calculate-btn" id="calculate-btn">Рассчитать для всех помещений</button>
            <div class="results-container" id="results-container"></div>
        </div>
        <footer>
            <p>Расчет является предварительным. Для точного подбора обратитесь к специалисту.</p>
        </footer>
    </div>
    <script>
        // Данные моделей теплого пола
        const models = [
            {name: 'ТКС-01', power: 230, powerM2: 460, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-02', power: 180, powerM2: 360, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-03', power: 180, powerM2: 250, area: 0.72, width: 1, length: 0.72},
            {name: 'ТКС-04', power: 160, powerM2: 213, area: 0.75, width: 1, length: 0.75},
            {name: 'ТКС-05', power: 140, powerM2: 165, area: 0.85, width: 1, length: 0.85},
            {name: 'ТКС-06', power: 140, powerM2: 140, area: 1, width: 1, length: 1},
            {name: 'ТКС-07', power: 100, powerM2: 71, area: 1.4, width: 1, length: 1.4},
            {name: 'ТКС-08', power: 180, powerM2: 257, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-09', power: 150, powerM2: 214, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-10', power: 150, powerM2: 185, area: 0.81, width: 0.7, length: 1.15},
            {name: 'ТКС-11', power: 145, powerM2: 188, area: 0.77, width: 0.7, length: 1.1},
            {name: 'ТКС-12', power: 140, powerM2: 200, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-13', power: 140, powerM2: 154, area: 0.91, width: 0.7, length: 1.3},
            {name: 'ТКС-14', power: 120, powerM2: 143, area: 0.84, width: 0.7, length: 1.2}
        ];

        let roomCounter = 0;
        let roomsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupOptionSelection('insulation-options');
            document.getElementById('add-room-btn').addEventListener('click', addRoom);
            document.getElementById('calculate-btn').addEventListener('click', calculateAllRooms);
            addRoom(); // Добавляем первое помещение по умолчанию
        });

        // Настройка выбора опций
        function setupOptionSelection(containerId) {
            const options = document.querySelectorAll(`#${containerId} .option-card`);
            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // Добавление нового помещения
        function addRoom() {
            roomCounter++;
            const roomId = `room-${roomCounter}`;
            const roomHTML = `
                <div class="room-container" id="${roomId}">
                    <div class="room-header">
                        <div class="room-title">Помещение ${roomCounter}</div>
                        <button class="remove-room" onclick="removeRoom('${roomId}')">Удалить</button>
                    </div>
                    <div class="room-dimensions">
                        <div class="dimension">
                            <label for="${roomId}-name">Название помещения</label>
                            <input type="text" id="${roomId}-name" value="Комната ${roomCounter}" placeholder="Например: Гостиная">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-length">Длина (м)</label>
                            <input type="number" id="${roomId}-length" min="0.5" max="50" step="0.1" value="4.5">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-width">Ширина (м)</label>
                            <input type="number" id="${roomId}-width" min="0.5" max="50" step="0.1" value="3.3">
                        </div>
                    </div>
                    <div class="area-info">
                        <p>Общая площадь: <span id="${roomId}-total-area">0</span> м²</p>
                        <p>Минимальная мощность: <span id="${roomId}-min-power">0</span> Вт</p>
                    </div>
                </div>
            `;
            document.getElementById('rooms-container').insertAdjacentHTML('beforeend', roomHTML);
            updateRoomArea(roomId);
            
            // Добавляем обработчики событий для обновления площади при изменении размеров
            document.getElementById(`${roomId}-length`).addEventListener('input', () => updateRoomArea(roomId));
            document.getElementById(`${roomId}-width`).addEventListener('input', () => updateRoomArea(roomId));
        }

        // Удаление помещения
        function removeRoom(roomId) {
            if (document.querySelectorAll('.room-container').length <= 1) {
                alert('Должно остаться хотя бы одно помещение');
                return;
            }
            document.getElementById(roomId).remove();
            renumberRooms();
        }

        // Перенумерация оставшихся помещений
        function renumberRooms() {
            const rooms = document.querySelectorAll('.room-container');
            roomCounter = 0;
            rooms.forEach((room, index) => {
                roomCounter++;
                const roomId = `room-${roomCounter}`;
                room.id = roomId;
                const header = room.querySelector('.room-title');
                header.textContent = `Помещение ${roomCounter}`;
                const nameInput = room.querySelector('input[type="text"]');
                if (nameInput.value === `Комната ${index + 1}`) {
                    nameInput.value = `Комната ${roomCounter}`;
                }
                const removeBtn = room.querySelector('.remove-room');
                removeBtn.setAttribute('onclick', `removeRoom('${roomId}')`);
                
                // Обновляем ID всех элементов внутри помещения
                const inputs = room.querySelectorAll('input');
                inputs.forEach(input => {
                    const oldId = input.id;
                    const newId = oldId.replace(/room-\d+/, roomId);
                    input.id = newId;
                });
                const spans = room.querySelectorAll('span');
                spans.forEach(span => {
                    const oldId = span.id;
                    if (oldId) {
                        const newId = oldId.replace(/room-\d+/, roomId);
                        span.id = newId;
                    }
                });
            });
        }

        // Обновление площади помещения и минимальной мощности
        function updateRoomArea(roomId) {
            const length = parseFloat(document.getElementById(`${roomId}-length`).value) || 0;
            const width = parseFloat(document.getElementById(`${roomId}-width`).value) || 0;
            const totalArea = length * width;
            const minPower = totalArea * 140; // Минимальная мощность 140 Вт/м²
            document.getElementById(`${roomId}-total-area`).textContent = totalArea.toFixed(2);
            document.getElementById(`${roomId}-min-power`).textContent = minPower.toFixed(0);
        }

        // Получение выбранного уровня утепления
        function getSelectedInsulation() {
            const selected = document.querySelector('#insulation-options .option-card.selected');
            return selected ? selected.getAttribute('data-value') : null;
        }

        // Округление до кратного 10 см (0.1 м)
        function roundToTenCm(value) {
            return Math.round(value * 10) / 10;
        }

        // Расчет расположения секций с учетом отступов от стен
        function calculateSectionLayout(roomLen, roomWid, model, orient90 = false) {
            // Отступ от стен 10 см
            const wallOffset = 0.1;
            
            // Доступная площадь после отступов
            const availableLen = roomLen - 2 * wallOffset;
            const availableWid = roomWid - 2 * wallOffset;
            
            if (availableLen <= 0 || availableWid <= 0) return null;
            
            // Определяем размеры секции в зависимости от ориентации
            const sectionWidth = orient90 ? model.length : model.width;
            const sectionLength = orient90 ? model.width : model.length;
            
            // Количество рядов, которые поместятся по ширине
            const numRows = Math.floor(availableWid / sectionWidth);
            if (numRows < 1) return null;
            
            // Центрирование рядов по ширине
            const totalRowWidth = numRows * sectionWidth;
            const offsetY = wallOffset + (availableWid - totalRowWidth) / 2;
            
            let allSections = [];
            let totalArea = 0;
            let sectionNumber = 1;
            let totalPower = 0;

            for (let r = 0; r < numRows; r++) {
                let xPos = wallOffset;
                let remainingLength = availableLen;
                
                // Количество полных секций в ряду
                const fullSectionsInRow = Math.floor(remainingLength / sectionLength);
                
                // Добавляем полные секции
                for (let i = 0; i < fullSectionsInRow; i++) {
                    allSections.push({
                        n: sectionNumber++,
                        width: sectionWidth,
                        length: sectionLength,
                        isPartial: false,
                        row: r,
                        x: xPos,
                        y: offsetY + r * sectionWidth,
                        power: model.power
                    });
                    
                    totalArea += sectionWidth * sectionLength;
                    totalPower += model.power;
                    remainingLength -= sectionLength;
                    xPos += sectionLength;
                }
                
                // Добавляем дробную секцию, если остаток >= 0.2м (кратно 10 см)
                if (remainingLength >= 0.2) {
                    // Округляем до кратного 10 см
                    const partialLength = roundToTenCm(remainingLength);
                    
                    if (partialLength >= 0.2) {
                        allSections.push({
                            n: sectionNumber++,
                            width: sectionWidth,
                            length: partialLength,
                            isPartial: true,
                            row: r,
                            x: xPos,
                            y: offsetY + r * sectionWidth,
                            power: model.power * (partialLength / sectionLength)
                        });
                        
                        totalArea += sectionWidth * partialLength;
                        totalPower += model.power * (partialLength / sectionLength);
                    }
                }
            }
            
            return {
                numRows,
                sectionWidth,
                sectionLength,
                offsetY,
                sections: allSections,
                area: totalArea,
                totalPower: totalPower,
                orient90,
                wallOffset
            };
        }

        // Проверка соответствия модели требованиям
        function checkFit(model, layout, roomLen, roomWid, minCoverage = 0.7) {
            if (!layout) return false;
            
            // Проверка покрытия
            const totalArea = roomLen * roomWid;
            const coverage = layout.area / totalArea;
            if (coverage < minCoverage) return false;
            
            // Проверка максимальной мощности (3360 Вт)
            if (layout.totalPower > 3360) return false;
            
            // Проверка минимальной мощности (140 Вт/м² от общей площади)
            const minRequiredPower = totalArea * 140;
            if (layout.totalPower < minRequiredPower) return false;
            
            return true;
        }

        // Поиск подходящей модели с расширенными критериями
        function findSuitableModel(length, width, insulation) {
            const totalArea = length * width;
            
            // Определяем требования к мощности в зависимости от утепления
            let minPower, maxPower;
            switch(insulation) {
                case 'low':
                    minPower = 180; // Расширили диапазон
                    maxPower = 500;
                    break;
                case 'medium':
                    minPower = 140; // Расширили диапазон
                    maxPower = 220;
                    break;
                case 'high':
                    minPower = 120; // Расширили диапазон
                    maxPower = 180;
                    break;
                default:
                    minPower = 140;
                    maxPower = 200;
            }
            
            // Фильтрация моделей по уровню утепления
            let suitableModels = models.filter(model => 
                model.powerM2 >= minPower && model.powerM2 <= maxPower
            ).sort((a, b) => b.powerM2 - a.powerM2);

            // Если не найдено подходящих моделей, расширяем критерии
            if (suitableModels.length === 0) {
                suitableModels = models.filter(model => 
                    model.powerM2 >= minPower * 0.8 // Еще больше расширяем диапазон
                ).sort((a, b) => b.powerM2 - a.powerM2);
            }
            
            return suitableModels;
        }

        // Расчет для одного помещения
        function calculateRoom(roomId, roomName, length, width, insulation) {
            const totalArea = length * width;
            const minRequiredPower = totalArea * 140; // Минимальная мощность 140 Вт/м²
            
            // Поиск подходящих моделей
            const suitableModels = findSuitableModel(length, width, insulation);
            
            let bestLayout = null;
            let bestModel = null;
            let bestCoverage = 0;
            let bestOrient90 = false;
            let usedFallback = false;

            // Перебираем подходящие модели и ориентации
            for (const model of suitableModels) {
                for (let orient90 = 0; orient90 <= 1; orient90++) {
                    const layout = calculateSectionLayout(length, width, model, !!orient90);
                    if (!checkFit(model, layout, length, width)) continue;
                    
                    const coverage = (layout.area / totalArea) * 100;
                    
                    // Предпочитаем решения с максимальным покрытием
                    if (!bestLayout || coverage > bestCoverage) {
                        bestLayout = layout;
                        bestModel = model;
                        bestCoverage = coverage;
                        bestOrient90 = !!orient90;
                    }
                }
            }
            
            // Если не нашли подходящую модель, попробуем все модели без фильтра по мощности
            if (!bestLayout) {
                usedFallback = true;
                for (const model of models) {
                    for (let orient90 = 0; orient90 <= 1; orient90++) {
                        const layout = calculateSectionLayout(length, width, model, !!orient90);
                        if (!checkFit(model, layout, length, width, 0.6)) continue; // Еще больше снижаем требование к покрытию
                        
                        const coverage = (layout.area / totalArea) * 100;
                        
                        if (!bestLayout || coverage > bestCoverage) {
                            bestLayout = layout;
                            bestModel = model;
                            bestCoverage = coverage;
                            bestOrient90 = !!orient90;
                        }
                    }
                }
            }
            
            if (!bestLayout) return { roomId, roomName, length, width, totalArea, minRequiredPower, success: false };

            // Расчет стоимости
            const thermostatCount = Math.max(1, Math.ceil(bestLayout.area / 20));
            const thermostatPrice = 5000;
            const thermostatTotal = thermostatPrice * thermostatCount;
            const installPrice = bestLayout.area * 1000 + thermostatCount * 3000;
            const floorPrice = bestLayout.area * 3000;
            const totalCost = installPrice + floorPrice + thermostatTotal;

            return {
                roomId,
                roomName,
                length,
                width,
                totalArea,
                minRequiredPower,
                model: bestModel,
                layout: bestLayout,
                coverage: bestLayout.area,
                coveragePercentage: bestCoverage,
                totalPower: bestLayout.totalPower,
                thermostatCount,
                thermostatPrice,
                thermostatTotal,
                installPrice,
                floorPrice,
                totalCost,
                sectionsNeeded: bestLayout.sections.length,
                orient90: bestOrient90,
                usedFallback,
                success: true
            };
        }

        // Визуализация схемы укладки
        function visualizeLayout(roomResult, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!roomResult.success) return;

            const roomLength = roomResult.length;
            const roomWidth = roomResult.width;
            const layout = roomResult.layout;

            // Масштабирование для отображения
            const maxWidth = container.offsetWidth - 20;
            const maxHeight = 280;
            const scaleX = maxWidth / roomLength;
            const scaleY = maxHeight / roomWidth;
            const scale = Math.min(scaleX, scaleY);

            // Контур помещения
            const roomElement = document.createElement('div');
            roomElement.className = 'room-outline';
            roomElement.style.width = `${roomLength * scale}px`;
            roomElement.style.height = `${roomWidth * scale}px`;
            roomElement.style.left = '50%';
            roomElement.style.top = '50%';
            roomElement.style.transform = 'translate(-50%, -50%)';
            roomElement.style.position = 'absolute';
            container.style.position = 'relative';
            container.appendChild(roomElement);

            // Отступы от стен
            const offsetElement = document.createElement('div');
            offsetElement.style.position = 'absolute';
            offsetElement.style.border = '1px dashed #ccc';
            offsetElement.style.left = `${layout.wallOffset * scale}px`;
            offsetElement.style.top = `${layout.wallOffset * scale}px`;
            offsetElement.style.width = `${(roomLength - 2 * layout.wallOffset) * scale}px`;
            offsetElement.style.height = `${(roomWidth - 2 * layout.wallOffset) * scale}px`;
            roomElement.appendChild(offsetElement);

            // Секции
            layout.sections.forEach(se => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = `section ${se.isPartial ? 'partial' : ''}`;
                sectionDiv.style.width = `${se.length * scale}px`;
                sectionDiv.style.height = `${se.width * scale}px`;
                sectionDiv.style.left = `${se.x * scale}px`;
                sectionDiv.style.top = `${se.y * scale}px`;
                sectionDiv.innerHTML = `
                    <div class="sec-label">${se.n}${se.isPartial ? '*' : ''}</div>
                    <div class="sec-size">${se.length.toFixed(2)}×${se.width.toFixed(2)}м</div>
                    ${se.isPartial ? `<div style="font-size:9px;color:#e67e22;">Дробная</div>` : ''}
                `;
                roomElement.appendChild(sectionDiv);
            });
        }

        // Расчет для всех помещений
        function calculateAllRooms() {
            const insulation = getSelectedInsulation();
            const rooms = document.querySelectorAll('.room-container');
            roomsData = [];
            
            if (rooms.length === 0) {
                showError('Добавьте хотя бы одно помещение');
                return;
            }
            
            let hasErrors = false;
            rooms.forEach(room => {
                const roomId = room.id;
                const roomName = document.getElementById(`${roomId}-name`).value || `Помещение ${roomId}`;
                const length = parseFloat(document.getElementById(`${roomId}-length`).value);
                const width = parseFloat(document.getElementById(`${roomId}-width`).value);
                
                if (!length || !width || length <= 0 || width <= 0) {
                    showError(`Заполните корректные размеры для ${roomName}`);
                    hasErrors = true;
                    return;
                }
                
                if (length < 0.5 || width < 0.5) {
                    showError(`Минимальный размер помещения - 0.5м. Проверьте ${roomName}`);
                    hasErrors = true;
                    return;
                }
                
                const roomResult = calculateRoom(roomId, roomName, length, width, insulation);
                roomsData.push(roomResult);
            });
            
            if (hasErrors) return;
            
            displayAllResults(roomsData);
        }

        // Отображение результатов расчета
        function displayAllResults(roomsData) {
            const container = document.getElementById('results-container');
            let html = '';
            let totalArea = 0;
            let totalCoverage = 0;
            let totalPower = 0;
            let totalCost = 0;
            let totalThermostats = 0;
            let totalSections = 0;
            let totalPartialSections = 0;
            
            // Считаем общие показатели
            roomsData.forEach(room => {
                if (room.success) {
                    totalArea += room.totalArea;
                    totalCoverage += room.coverage;
                    totalPower += room.totalPower;
                    totalCost += room.totalCost;
                    totalThermostats += room.thermostatCount;
                    totalSections += room.sectionsNeeded;
                    totalPartialSections += room.layout.sections.filter(s => s.isPartial).length;
                }
            });
            
            // Результаты для каждого помещения
            roomsData.forEach((room, index) => {
                if (!room.success) {
                    html += `
                        <div class="room-result">
                            <div class="room-result-header">${room.roomName} - Не найдено подходящей модели</div>
                            <div class="warning" style="margin: 15px;">
                                Для помещения ${room.length}м × ${room.width}м не найдено подходящей модели. 
                                Требуемая минимальная мощность: ${room.minRequiredPower.toFixed(0)} Вт.
                                Попробуйте изменить размеры или параметры утепления.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const visualizationId = `visualization-${index}`;
                const partialSections = room.layout.sections.filter(s => s.isPartial).length;
                const fullSections = room.sectionsNeeded - partialSections;
                const availableArea = (room.length - 0.2) * (room.width - 0.2); // Минус отступы 10 см с каждой стороны
                const coverageEfficiency = (room.coverage / availableArea) * 100;
                
                html += `
                    <div class="room-result">
                        <div class="room-result-header">${room.roomName} (${room.length}м × ${room.width}м)</div>
                        <div class="room-result-content">
                            <div class="result-card">
                                <h4>ОПТИМАЛЬНАЯ МОДЕЛЬ: ${room.model.name}</h4>
                                ${room.usedFallback ? 
                                    `<div class="fallback-info">Внимание: использована модель с нестандартной мощностью для выбранного уровня утепления.</div>` : 
                                    ''
                                }
                                <div class="min-power-info">
                                    <strong>Минимальная мощность для помещения:</strong> ${room.minRequiredPower.toFixed(0)} Вт (140 Вт/м² × ${room.totalArea.toFixed(1)} м²)
                                </div>
                                ${coverageEfficiency > 95 ? 
                                    `<div class="coverage-success">Отличное покрытие! Заполнено ${coverageEfficiency.toFixed(1)}% доступной площади.</div>` : 
                                    `<div class="coverage-info">Заполнено ${coverageEfficiency.toFixed(1)}% доступной площади (с учетом отступов от стен).</div>`
                                }
                                <div class="result-grid">
                                    <div class="result-item"><strong>Мощность на м²:</strong> ${room.model.powerM2} Вт/м²</div>
                                    <div class="result-item"><strong>Мощность секции:</strong> ${room.model.power} Вт</div>
                                    <div class="result-item"><strong>Полных секций:</strong> ${fullSections}</div>
                                    <div class="result-item"><strong>Дробных секций:</strong> ${partialSections} (кратно 10 см)</div>
                                    <div class="result-item"><strong>Покрываемая площадь:</strong> ${room.coverage.toFixed(2)} м²</div>
                                    <div class="result-item"><strong>Общая мощность:</strong> ${room.totalPower.toFixed(0)} Вт</div>
                                    <div class="result-item"><strong>Размер секции:</strong> ${room.model.width}м × ${room.model.length}м</div>
                                    <div class="result-item"><strong>Ориентация укладки:</strong> ${room.orient90 ? "Поворот секции на 90°" : "Без поворота"}</div>
                                </div>
                                ${room.totalPower > 2500 ? 
                                    `<div class="power-warning">Внимание: Мощность близка к предельной. Убедитесь в надежности электропроводки и согласуйте проект с электриком.</div>` : ''
                                }
                                <div class="section-info">
                                    <strong>Секции (дробные кратны 10 см):</strong>
                                    <div class="section-list">
                                        ${room.layout.sections.map(s => 
                                            `<div class="section-item">Секция ${s.n}: ${s.length.toFixed(2)}м × ${s.width.toFixed(2)}м ${s.isPartial ? '(дробная)' : ''}</div>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="layout-visualization">
                                <div class="visualization-title">Схема укладки (отступ от стен 10 см)</div>
                                <div class="visualization-container" id="${visualizationId}"></div>
                                <div class="coverage-info">
                                    Покрытие: ${room.coveragePercentage.toFixed(1)}% от общей площади помещения
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Общий итог
            if (roomsData.some(room => room.success)) {
                html += `
                    <div class="total-summary">
                        <h3>ОБЩИЙ ИТОГ ПО ВСЕМУ ЗДАНИЮ</h3>
                        <table class="summary-table">
                            <tr><th>Общая площадь помещений</th><td>${totalArea.toFixed(2)} м²</td></tr>
                            <tr><th>Общая площадь укладки</th><td>${totalCoverage.toFixed(2)} м²</td></tr>
                            <tr><th>Минимальная требуемая мощность</th><td>${(totalArea * 140).toFixed(0)} Вт</td></tr>
                            <tr><th>Общая мощность системы</th><td>${totalPower.toFixed(0)} Вт</td></tr>
                            <tr><th>Количество терморегуляторов</th><td>${totalThermostats} шт.</td></tr>
                            <tr><th>Всего секций</th><td>${totalSections} шт. (${totalPartialSections} дробных, кратных 10 см)</td></tr>
                            <tr><th>Общая стоимость</th><td>${totalCost.toLocaleString('ru-RU')} руб.</td></tr>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Визуализация схем укладки после отрисовки DOM
            roomsData.forEach((room, index) => {
                if (room.success) {
                    setTimeout(() => {
                        visualizeLayout(room, `visualization-${index}`);
                    }, 100);
                }
            });
        }

        // Отображение ошибок
        function showError(message) {
            const constainer = document.getElementById('results-container');
            container.innerHTML = `<div class="warning">${message}</div>`;
        }
    </script>
</body>
</html>
