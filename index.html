<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор теплого пола - Многокомнатный расчет</title>
    <style>
        /* Стили остаются без изменений, они хорошо продуманы */
        body { background: #f5f7fa; color: #333; font-family: Arial, sans-serif; }
        .calculator-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: #2c3e50; color: white; padding: 30px; text-align: center; }
        .calculator-content { padding: 30px; }
        .step { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .step-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; justify-content: space-between; }
        .step-number { background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .option-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .option-card.selected { border-color: #3498db; background-color: #ebf5fb; }
        .room-container { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #f9f9f9; }
        .calculate-btn { width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 20px 0; }
        .calculate-btn:hover { background: #2980b9; }
        .results-container { margin-top: 30px; }
        .room-result { margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .room-result-header { background: #34495e; color: white; padding: 15px; font-size: 18px; font-weight: bold; }
        .room-result-content { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .result-card { border: 2px solid #27ae60; border-radius: 8px; padding: 20px; background-color: #f0fff4; }
        .result-card h4 { font-size: 20px; margin-bottom: 15px; color: #2c3e50; text-align: center; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .result-item { padding: 8px; background: #f8f9fa; border-radius: 6px; }
        .layout-visualization { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: white; }
        .visualization-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .visualization-container { width: 100%; height: 300px; border: 1px solid #ddd; position: relative; background: #f9f9f9; margin-bottom: 10px; }
        .room-outline { position: absolute; border: 2px solid #3498db; background: rgba(52, 152, 219, 0.1); }
        .section { position: absolute; border: 1px solid #e74c3c; background: rgba(231, 76, 60, 0.2); display: flex; align-items: center; justify-content: center; font-size: 11px; color: #c0392b; overflow: hidden; flex-direction: column;}
        .section .sec-label { font-weight: bold; }
        .section .sec-size { font-size: 10px; color: #333; }
        .coverage-info { background: #e8f4f8; color: #2c3e50; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 14px; text-align: center; }
        .warning { background: #fee; color: #c0392b; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #c0392b; }
        .power-warning { background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107; }
        
        /* Дополнительные стили для улучшения UX */
        .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .room-dimensions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .dimension { display: flex; flex-direction: column; }
        .dimension label { font-weight: bold; margin-bottom: 5px; }
        .dimension input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .area-info { background: #e8f4f8; padding: 10px; border-radius: 6px; text-align: center; }
        .remove-room { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .add-room-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .total-summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th, .summary-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .summary-table th { background: #34495e; color: white; }
        
        @media (max-width: 768px) {
            .room-result-content { grid-template-columns: 1fr; }
            .room-dimensions { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <header>
            <h1>Калькулятор теплого пола - Многокомнатный расчет</h1>
            <p>Рассчитайте оптимальные модели для всех помещений вашего здания</p>
        </header>
        <div class="calculator-content">
            <div class="step">
                <div class="step-title">
                    <div style="display: flex; align-items: center;">
                        <span class="step-number">1</span>
                        Оцените утепление помещения
                    </div>
                </div>
                <div class="options-grid" id="insulation-options">
                    <div class="option-card selected" data-value="low">
                        <h3>Низкое утепление</h3>
                        <p>Балкон, лоджия, старый дом</p>
                        <div class="power-info">Рекомендуемая мощность: от 200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="medium">
                        <h3>Среднее утепление</h3>
                        <p>Городская квартира</p>
                        <div class="power-info">Рекомендуемая мощность: 180-200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="high">
                        <h3>Высокое утепление</h3>
                        <p>Новостройка, утепленный дом</p>
                        <div class="power-info">Рекомендуемая мощность: 140-180 Вт/м²</div>
                    </div>
                </div>
            </div>
            <div class="step">
                <div class="step-title">
                    <div style="display: flex; align-items: center;">
                        <span class="step-number">2</span>
                        Добавьте помещения для расчета
                    </div>
                </div>
                <div id="rooms-container"></div>
                <button class="add-room-btn" id="add-room-btn">+ Добавить помещение</button>
            </div>
            <button class="calculate-btn" id="calculate-btn">Рассчитать для всех помещений</button>
            <div class="results-container" id="results-container"></div>
        </div>
        <footer style="padding: 20px; text-align: center; background: #f8f9fa; color: #666; font-size: 14px;">
            <p>Расчет является предварительным. Для точного подбора обратитесь к специалисту.</p>
        </footer>
    </div>
    <script>
        // Данные моделей теплого пола
        const models = [
            {name: 'ТКС-01', power: 230, powerM2: 460, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-02', power: 180, powerM2: 360, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-03', power: 180, powerM2: 250, area: 0.72, width: 1, length: 0.72},
            {name: 'ТКС-04', power: 160, powerM2: 213, area: 0.75, width: 1, length: 0.75},
            {name: 'ТКС-05', power: 140, powerM2: 165, area: 0.85, width: 1, length: 0.85},
            {name: 'ТКС-06', power: 140, powerM2: 140, area: 1, width: 1, length: 1},
            {name: 'ТКС-07', power: 100, powerM2: 71, area: 1.4, width: 1, length: 1.4},
            {name: 'ТКС-08', power: 180, powerM2: 257, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-09', power: 150, powerM2: 214, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-10', power: 150, powerM2: 185, area: 0.81, width: 0.7, length: 1.15},
            {name: 'ТКС-11', power: 145, powerM2: 188, area: 0.77, width: 0.7, length: 1.1},
            {name: 'ТКС-12', power: 140, powerM2: 200, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-13', power: 140, powerM2: 154, area: 0.91, width: 0.7, length: 1.3},
            {name: 'ТКС-14', power: 120, powerM2: 143, area: 0.84, width: 0.7, length: 1.2}
        ];

        let roomCounter = 0;
        let roomsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupOptionSelection('insulation-options');
            document.getElementById('add-room-btn').addEventListener('click', addRoom);
            document.getElementById('calculate-btn').addEventListener('click', calculateAllRooms);
            addRoom(); // Добавляем первое помещение по умолчанию
        });

        // Настройка выбора опций
        function setupOptionSelection(containerId) {
            const options = document.querySelectorAll(`#${containerId} .option-card`);
            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // Добавление нового помещения
        function addRoom() {
            roomCounter++;
            const roomId = `room-${roomCounter}`;
            const roomHTML = `
                <div class="room-container" id="${roomId}">
                    <div class="room-header">
                        <div class="room-title">Помещение ${roomCounter}</div>
                        <button class="remove-room" onclick="removeRoom('${roomId}')">Удалить</button>
                    </div>
                    <div class="room-dimensions">
                        <div class="dimension">
                            <label for="${roomId}-name">Название помещения</label>
                            <input type="text" id="${roomId}-name" value="Комната ${roomCounter}" placeholder="Например: Гостиная">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-length">Длина (м)</label>
                            <input type="number" id="${roomId}-length" min="1" max="20" step="0.1" value="${4 + roomCounter * 0.5}">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-width">Ширина (м)</label>
                            <input type="number" id="${roomId}-width" min="1" max="20" step="0.1" value="${3 + roomCounter * 0.3}">
                        </div>
                    </div>
                    <div class="area-info">
                        <p>Общая площадь: <span id="${roomId}-total-area">0</span> м²</p>
                        <p>Целевая площадь (90%): <span id="${roomId}-effective-area">0</span> м²</p>
                    </div>
                </div>
            `;
            document.getElementById('rooms-container').insertAdjacentHTML('beforeend', roomHTML);
            updateRoomArea(roomId);
            
            // Добавляем обработчики событий для обновления площади при изменении размеров
            document.getElementById(`${roomId}-length`).addEventListener('input', () => updateRoomArea(roomId));
            document.getElementById(`${roomId}-width`).addEventListener('input', () => updateRoomArea(roomId));
        }

        // Удаление помещения
        function removeRoom(roomId) {
            if (document.querySelectorAll('.room-container').length <= 1) {
                alert('Должно остаться хотя бы одно помещение');
                return;
            }
            document.getElementById(roomId).remove();
            renumberRooms();
        }

        // Перенумерация оставшихся помещений
        function renumberRooms() {
            const rooms = document.querySelectorAll('.room-container');
            roomCounter = 0;
            rooms.forEach((room, index) => {
                roomCounter++;
                const roomId = `room-${roomCounter}`;
                room.id = roomId;
                const header = room.querySelector('.room-title');
                header.textContent = `Помещение ${roomCounter}`;
                const nameInput = room.querySelector('input[type="text"]');
                if (nameInput.value === `Комната ${index + 1}`) {
                    nameInput.value = `Комната ${roomCounter}`;
                }
                const removeBtn = room.querySelector('.remove-room');
                removeBtn.setAttribute('onclick', `removeRoom('${roomId}')`);
                
                // Обновляем ID всех элементов внутри помещения
                const inputs = room.querySelectorAll('input');
                inputs.forEach(input => {
                    const oldId = input.id;
                    const newId = oldId.replace(/room-\d+/, roomId);
                    input.id = newId;
                });
                const spans = room.querySelectorAll('span');
                spans.forEach(span => {
                    const oldId = span.id;
                    if (oldId) {
                        const newId = oldId.replace(/room-\d+/, roomId);
                        span.id = newId;
                    }
                });
            });
        }

        // Обновление площади помещения
        function updateRoomArea(roomId) {
            const length = parseFloat(document.getElementById(`${roomId}-length`).value) || 0;
            const width = parseFloat(document.getElementById(`${roomId}-width`).value) || 0;
            const totalArea = length * width;
            const effectiveArea = totalArea * 0.9;
            document.getElementById(`${roomId}-total-area`).textContent = totalArea.toFixed(2);
            document.getElementById(`${roomId}-effective-area`).textContent = effectiveArea.toFixed(2);
        }

        // Получение выбранного уровня утепления
        function getSelectedInsulation() {
            const selected = document.querySelector('#insulation-options .option-card.selected');
            return selected ? selected.getAttribute('data-value') : null;
        }

        // Расчет расположения секций
        function calculateSectionLayout(roomLen, roomWid, model, orient90 = false) {
            const rowWidth = orient90 ? model.length : model.width;
            const rowLength = orient90 ? model.width : model.length;

            const numRows = Math.floor(roomWid / rowWidth);
            if (numRows < 1) return null;
            const coveredWidth = numRows * rowWidth;
            const offsetY = (roomWid - coveredWidth) / 2;

            let allSections = [];
            let totalArea = 0;
            let sectionNumber = 1;

            for (let r = 0; r < numRows; r++) {
                let xRow = 0;
                let remaining = roomLen;

                while (remaining >= rowLength - 0.0001) {
                    allSections.push({
                        n: sectionNumber++,
                        width: rowWidth,
                        length: rowLength,
                        isPartial: false,
                        row: r,
                        x: xRow,
                        y: offsetY + r * rowWidth
                    });
                    totalArea += rowWidth * rowLength;
                    remaining -= rowLength;
                    xRow += rowLength;
                }
                // Дробная секция в ряду, только если остаток >= 0.2м
                if (remaining >= 0.2) {
                    allSections.push({
                        n: sectionNumber++,
                        width: rowWidth,
                        length: remaining,
                        isPartial: true,
                        row: r,
                        x: xRow,
                        y: offsetY + r * rowWidth
                    });
                    totalArea += rowWidth * remaining;
                }
            }
            return {
                numRows,
                rowWidth,
                rowLength,
                offsetY,
                sections: allSections,
                area: totalArea,
                orient90
            };
        }

        // Проверка соответствия модели требованиям
        function checkFit(model, layout, roomLen, roomWid, minCoverage = 0.85) {
            if (!layout) return false;
            // Мощность
            const maxPower = 3360;
            const totalPower = layout.sections.length * model.power;
            if (totalPower > maxPower) return false;
            // Покрытие
            const totalArea = roomLen * roomWid;
            const coverage = layout.area / totalArea;
            if (coverage < minCoverage) return false;
            return true;
        }

        // Расчет для одного помещения
        function calculateRoom(roomId, roomName, length, width, insulation) {
            const totalArea = length * width;
            const suitableModels = models.filter(model => {
                if (insulation === 'low' && model.powerM2 >= 200) return true;
                if (insulation === 'medium' && model.powerM2 >= 180 && model.powerM2 <= 200) return true;
                if (insulation === 'high' && model.powerM2 >= 140 && model.powerM2 <= 180) return true;
                return false;
            }).sort((a, b) => b.powerM2 - a.powerM2);

            let best = null;
            let bestModel = null;
            let bestCoverage = 0;
            let bestOrient90 = false;

            for (const model of suitableModels) {
                for (let orient90 = 0; orient90 <= 1; orient90++) {
                    const layout = calculateSectionLayout(length, width, model, !!orient90);
                    if (!checkFit(model, layout, length, width)) continue;
                    const coverage = (layout.area / totalArea) * 100;
                    const d = Math.abs(coverage - 90);
                    if (!best || d < Math.abs(bestCoverage - 90)) {
                        best = layout;
                        bestModel = model;
                        bestCoverage = coverage;
                        bestOrient90 = !!orient90;
                    }
                }
            }
            if (!best) return { roomId, roomName, length, width, totalArea, success: false };

            // Итоговые данные
            const totalPower = best.sections.length * bestModel.power;
            const thermostatCount = Math.max(1, Math.ceil(best.area / 20));
            const thermostatPrice = 5000;
            const thermostatTotal = thermostatPrice * thermostatCount;
            const installPrice = best.area * 1000 + thermostatCount * 3000;
            const floorPrice = best.area * 3000;
            const totalCost = installPrice + floorPrice + thermostatTotal;

            return {
                roomId,
                roomName,
                length,
                width,
                totalArea,
                model: bestModel,
                layout: best,
                coverage: best.area,
                coveragePercentage: bestCoverage,
                totalPower,
                thermostatCount,
                thermostatPrice,
                thermostatTotal,
                installPrice,
                floorPrice,
                totalCost,
                sectionsNeeded: best.sections.length,
                orient90: bestOrient90,
                success: true
            };
        }

        // Визуализация схемы укладки
        function visualizeLayout(roomResult, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!roomResult.success) return;

            const roomLength = roomResult.length;
            const roomWidth = roomResult.width;
            const layout = roomResult.layout;
            const model = roomResult.model;

            const maxWidth = 400;
            const maxHeight = 280;
            const scaleX = maxWidth / roomLength;
            const scaleY = maxHeight / roomWidth;
            const scale = Math.min(scaleX, scaleY);

            // Центрирование по ширине
            const usedWidth = layout.numRows * layout.rowWidth;
            const offsetY = ((roomWidth - usedWidth) / 2) * scaleY;

            // Контур помещения
            const roomElement = document.createElement('div');
            roomElement.className = 'room-outline';
            roomElement.style.width = `${roomLength * scale}px`;
            roomElement.style.height = `${roomWidth * scale}px`;
            roomElement.style.left = '50%';
            roomElement.style.top = '50%';
            roomElement.style.transform = 'translate(-50%, -50%)';
            roomElement.style.position = 'absolute';
            container.style.position = 'relative';
            container.appendChild(roomElement);

            // Секции
            layout.sections.forEach(se => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                sectionDiv.style.width = `${se.length * scale}px`;
                sectionDiv.style.height = `${se.width * scale}px`;
                sectionDiv.style.left = `${se.x * scale}px`;
                sectionDiv.style.top = `${(se.y) * scaleY}px`;
                sectionDiv.innerHTML = `<div class="sec-label">${se.n}</div>
                    <div class="sec-size">${se.length.toFixed(2)}×${se.width.toFixed(2)}м</div>`;
                roomElement.appendChild(sectionDiv);
            });
        }

        // Расчет для всех помещений
        function calculateAllRooms() {
            const insulation = getSelectedInsulation();
            const rooms = document.querySelectorAll('.room-container');
            roomsData = [];
            
            if (rooms.length === 0) {
                showError('Добавьте хотя бы одно помещение');
                return;
            }
            
            let hasErrors = false;
            rooms.forEach(room => {
                const roomId = room.id;
                const roomName = document.getElementById(`${roomId}-name`).value || `Помещение ${roomId}`;
                const length = parseFloat(document.getElementById(`${roomId}-length`).value);
                const width = parseFloat(document.getElementById(`${roomId}-width`).value);
                
                if (!length || !width || length <= 0 || width <= 0) {
                    showError(`Заполните корректные размеры для ${roomName}`);
                    hasErrors = true;
                    return;
                }
                
                const roomResult = calculateRoom(roomId, roomName, length, width, insulation);
                roomsData.push(roomResult);
            });
            
            if (hasErrors) return;
            
            displayAllResults(roomsData);
        }

        // Отображение результатов расчета
        function displayAllResults(roomsData) {
            const container = document.getElementById('results-container');
            let html = '';
            let totalArea = 0;
            let totalCoverage = 0;
            let totalPower = 0;
            let totalCost = 0;
            let totalThermostats = 0;
            
            roomsData.forEach(room => {
                if (room.success) {
                    totalArea += room.totalArea;
                    totalCoverage += room.coverage;
                    totalPower += room.totalPower;
                    totalCost += room.totalCost;
                    totalThermostats += room.thermostatCount;
                }
            });
            
            roomsData.forEach((room, index) => {
                if (!room.success) {
                    html += `
                        <div class="room-result">
                            <div class="room-result-header">${room.roomName} - Не найдено подходящей модели</div>
                            <div class="warning" style="margin: 15px;">
                                Для помещения ${room.length}м × ${room.width}м не найдено подходящей модели. Попробуйте изменить размеры или параметры утепления.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const visualizationId = `visualization-${index}`;
                html += `
                    <div class="room-result">
                        <div class="room-result-header">${room.roomName} (${room.length}м × ${room.width}м)</div>
                        <div class="room-result-content">
                            <div class="result-card">
                                <h4>ОПТИМАЛЬНАЯ МОДЕЛЬ: ${room.model.name}</h4>
                                <div class="result-grid">
                                    <div class="result-item"><strong>Мощность на м²:</strong> ${room.model.powerM2} Вт/м²</div>
                                    <div class="result-item"><strong>Мощность секции:</strong> ${room.model.power} Вт</div>
                                    <div class="result-item"><strong>Секций требуется:</strong> ${room.sectionsNeeded}</div>
                                    <div class="result-item"><strong>Покрываемая площадь:</strong> ${room.coverage.toFixed(2)} м²</div>
                                    <div class="result-item"><strong>Общая мощность:</strong> ${room.totalPower} Вт</div>
                                    <div class="result-item"><strong>Размер секции:</strong> ${room.model.width}м × ${room.model.length}м</div>
                                    <div class="result-item"><strong>Ориентация укладки:</strong> ${room.orient90 ? "Поворот секции на 90°" : "Без поворота"}</div>
                                </div>
                                ${room.totalPower > 2500 ? 
                                    `<div class="power-warning">Внимание: Мощность близка к предельной. Убедитесь в надежности электропроводки и согласуйте проект с электриком.</div>` : ''
                                }
                            </div>
                            <div class="layout-visualization">
                                <div class="visualization-title">Схема укладки</div>
                                <div class="visualization-container" id="${visualizationId}"></div>
                                <div class="coverage-info">
                                    Покрытие: ${room.coveragePercentage.toFixed(1)}% от общей площади помещения
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (roomsData.some(room => room.success)) {
                html += `
                    <div class="total-summary">
                        <h3>ОБЩИЙ ИТОГ ПО ВСЕМУ ЗДАНИЮ</h3>
                        <table class="summary-table">
                            <tr><th>Общая площадь помещений</th><td>${totalArea.toFixed(2)} м²</td></tr>
                            <tr><th>Общая площадь укладки</th><td>${totalCoverage.toFixed(2)} м²</td></tr>
                            <tr><th>Общая мощность системы</th><td>${totalPower} Вт</td></tr>
                            <tr><th>Количество терморегуляторов</th><td>${totalThermostats} шт.</td></tr>
                            <tr><th>Общая стоимость</th><td>${totalCost.toLocaleString('ru-RU')} руб.</td></tr>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Визуализация схем укладки после отрисовки DOM
            roomsData.forEach((room, index) => {
                if (room.success) {
                    setTimeout(() => {
                        visualizeLayout(room, `visualization-${index}`);
                    }, 100);
                }
            });
        }

        // Отображение ошибок
        function showError(message) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<div class="warning">${message}</div>`;
        }
    </script>
</body>
</html>
