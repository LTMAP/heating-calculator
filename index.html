<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор теплого пола - Многокомнатный расчет</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .calculator-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .calculator-content {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .step-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .option-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-card:hover {
            border-color: #3498db;
        }
        
        .option-card.selected {
            border-color: #3498db;
            background-color: #ebf5fb;
        }
        
        .option-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .option-card p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .option-card .power-info {
            font-size: 14px;
            color: #3498db;
            font-weight: bold;
        }
        
        .room-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .room-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .remove-room {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .room-dimensions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .dimension {
            display: flex;
            flex-direction: column;
        }
        
        .dimension label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }
        
        .dimension input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .area-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .area-info p {
            margin: 3px 0;
            font-weight: 500;
        }
        
        .add-room-btn {
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin: 20px 0;
        }
        
        .calculate-btn:hover {
            background: #2980b9;
        }
        
        .download-btn {
            width: 100%;
            padding: 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin: 20px 0;
        }
        
        .download-btn:hover {
            background: #219653;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .room-result {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .room-result-header {
            background: #34495e;
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .room-result-content {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-card {
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 20px;
            background-color: #f0fff4;
        }
        
        .result-card h4 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .result-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .result-item strong {
            color: #555;
        }
        
        .layout-visualization {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        
        .visualization-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .visualization-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            position: relative;
            background: #f9f9f9;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .room-outline {
            position: absolute;
            border: 2px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
            box-sizing: border-box;
        }
        
        .section {
            position: absolute;
            border: 1px solid #e74c3c;
            background: rgba(231, 76, 60, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #c0392b;
            box-sizing: border-box;
        }
        
        .section.cut {
            background: rgba(231, 76, 60, 0.1);
            border-style: dashed;
        }
        
        .layout-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .summary-table {
            width: 100%;
            margin-top: 15px;
            margin-bottom: 10px;
            border-collapse: collapse;
        }
        
        .summary-table th, .summary-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 10px;
            text-align: left;
        }
        
        .summary-table th {
            background: #ebf5fb;
        }
        
        .summary-table tfoot td {
            font-weight: bold;
            background: #f0fff4;
        }
        
        .warning {
            background: #fee;
            color: #c0392b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #c0392b;
        }
        
        .power-warning {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        
        .coverage-info {
            background: #e8f4f8;
            color: #2c3e50;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .summary-result {
            background: #e0f9e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            margin-top: 15px;
            padding: 15px;
            font-size: 18px;
        }
        
        .total-summary {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .total-summary h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .room-dimensions {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .calculator-content {
                padding: 15px;
            }
            
            .room-result-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <header>
            <h1>Калькулятор теплого пола - Многокомнатный расчет</h1>
            <p>Рассчитайте оптимальные модели для всех помещений вашего здания</p>
        </header>
        
        <div class="calculator-content">
            <div class="step">
                <div class="step-title">
                    <div style="display: flex; align-items: center;">
                        <span class="step-number">1</span>
                        Оцените утепление помещения
                    </div>
                </div>
                <div class="options-grid" id="insulation-options">
                    <div class="option-card selected" data-value="low">
                        <h3>Низкое утепление</h3>
                        <p>Балкон, лоджия, старый дом</p>
                        <div class="power-info">Рекомендуемая мощность: от 200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="medium">
                        <h3>Среднее утепление</h3>
                        <p>Городская квартира</p>
                        <div class="power-info">Рекомендуемая мощность: 180-200 Вт/м²</div>
                    </div>
                    <div class="option-card" data-value="high">
                        <h3>Высокое утепление</h3>
                        <p>Новостройка, утепленный дом</p>
                        <div class="power-info">Рекомендуемая мощность: 140-180 Вт/м²</div>
                    </div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-title">
                    <div style="display: flex; align-items: center;">
                        <span class="step-number">2</span>
                        Добавьте помещения для расчета
                    </div>
                </div>
                
                <div id="rooms-container">
                    <!-- Помещения будут добавляться здесь -->
                </div>
                
                <button class="add-room-btn" id="add-room-btn">+ Добавить помещение</button>
            </div>
            
            <button class="calculate-btn" id="calculate-btn">Рассчитать для всех помещений</button>
            
            <div class="results-container" id="results-container">
                <!-- Результаты появятся здесь -->
            </div>

            <button class="download-btn" id="download-pdf-btn" style="display: none;">Скачать расчет (PDF)</button>
        </div>
        
        <footer>
            <p>Расчет является предварительным. Для точного подбора обратитесь к специалисту.</p>
        </footer>
    </div>

    <script>
        // Данные моделей
        const models = [
            {name: 'ТКС-01', power: 230, powerM2: 460, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-02', power: 180, powerM2: 360, area: 0.5, width: 1, length: 0.5},
            {name: 'ТКС-03', power: 180, powerM2: 250, area: 0.72, width: 1, length: 0.72},
            {name: 'ТКС-04', power: 160, powerM2: 213, area: 0.75, width: 1, length: 0.75},
            {name: 'ТКС-05', power: 140, powerM2: 165, area: 0.85, width: 1, length: 0.85},
            {name: 'ТКС-06', power: 140, powerM2: 140, area: 1, width: 1, length: 1},
            {name: 'ТКС-07', power: 100, powerM2: 71, area: 1.4, width: 1, length: 1.4},
            {name: 'ТКС-08', power: 180, powerM2: 257, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-09', power: 150, powerM2: 214, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-10', power: 150, powerM2: 185, area: 0.81, width: 0.7, length: 1.15},
            {name: 'ТКС-11', power: 145, powerM2: 188, area: 0.77, width: 0.7, length: 1.1},
            {name: 'ТКС-12', power: 140, powerM2: 200, area: 0.7, width: 0.7, length: 1},
            {name: 'ТКС-13', power: 140, powerM2: 154, area: 0.91, width: 0.7, length: 1.3},
            {name: 'ТКС-14', power: 120, powerM2: 143, area: 0.84, width: 0.7, length: 1.2}
        ];

        const MAX_POWER_PER_CIRCUIT = 3360;

        let roomCounter = 0;
        let roomsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupOptionSelection('insulation-options');
            document.getElementById('add-room-btn').addEventListener('click', addRoom);
            document.getElementById('calculate-btn').addEventListener('click', calculateAllRooms);
            document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
            addRoom();
        });

        function setupOptionSelection(containerId) {
            const options = document.querySelectorAll(`#${containerId} .option-card`);
            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function addRoom() {
            roomCounter++;
            const roomId = `room-${roomCounter}`;
            
            const roomHTML = `
                <div class="room-container" id="${roomId}">
                    <div class="room-header">
                        <div class="room-title">Помещение ${roomCounter}</div>
                        <button class="remove-room" onclick="removeRoom('${roomId}')">Удалить</button>
                    </div>
                    <div class="room-dimensions">
                        <div class="dimension">
                            <label for="${roomId}-name">Название помещения</label>
                            <input type="text" id="${roomId}-name" value="Комната ${roomCounter}" placeholder="Например: Гостиная">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-length">Длина (м)</label>
                            <input type="number" id="${roomId}-length" min="0.1" max="50" step="0.1" value="${4 + roomCounter * 0.5}">
                        </div>
                        <div class="dimension">
                            <label for="${roomId}-width">Ширина (м)</label>
                            <input type="number" id="${roomId}-width" min="0.1" max="50" step="0.1" value="${3 + roomCounter * 0.3}">
                        </div>
                    </div>
                    <div class="area-info">
                        <p>Общая площадь: <span id="${roomId}-total-area">0</span> м²</p>
                        <p>Целевая площадь (90%): <span id="${roomId}-effective-area">0</span> м²</p>
                    </div>
                </div>
            `;
            
            document.getElementById('rooms-container').insertAdjacentHTML('beforeend', roomHTML);
            updateRoomArea(roomId);
            document.getElementById(`${roomId}-length`).addEventListener('input', () => updateRoomArea(roomId));
            document.getElementById(`${roomId}-width`).addEventListener('input', () => updateRoomArea(roomId));
        }

        function removeRoom(roomId) {
            if (document.querySelectorAll('.room-container').length <= 1) {
                alert('Должно остаться хотя бы одно помещение');
                return;
            }
            document.getElementById(roomId).remove();
            renumberRooms();
        }

        function renumberRooms() {
            const rooms = document.querySelectorAll('.room-container');
            roomCounter = 0;
            rooms.forEach((room, index) => {
                roomCounter++;
                const roomId = `room-${roomCounter}`;
                room.id = roomId;
                const header = room.querySelector('.room-title');
                header.textContent = `Помещение ${roomCounter}`;
                const nameInput = room.querySelector('input[type="text"]');
                if (nameInput.value === `Комната ${index + 1}`) {
                    nameInput.value = `Комната ${roomCounter}`;
                }
                const removeBtn = room.querySelector('.remove-room');
                removeBtn.setAttribute('onclick', `removeRoom('${roomId}')`);
                const inputs = room.querySelectorAll('input');
                inputs.forEach(input => {
                    const oldId = input.id;
                    const newId = oldId.replace(/room-\d+/, roomId);
                    input.id = newId;
                });
                const spans = room.querySelectorAll('span');
                spans.forEach(span => {
                    const oldId = span.id;
                    if (oldId) {
                        const newId = oldId.replace(/room-\d+/, roomId);
                        span.id = newId;
                    }
                });
            });
        }

        function updateRoomArea(roomId) {
            const length = parseFloat(document.getElementById(`${roomId}-length`).value) || 0;
            const width = parseFloat(document.getElementById(`${roomId}-width`).value) || 0;
            const totalArea = length * width;
            const effectiveArea = totalArea * 0.9;
            const totalSpan = document.getElementById(`${roomId}-total-area`);
            const effSpan = document.getElementById(`${roomId}-effective-area`);
            if (totalSpan) totalSpan.textContent = totalArea.toFixed(2);
            if (effSpan) effSpan.textContent = effectiveArea.toFixed(2);
        }

        function getSelectedInsulation() {
            const selected = document.querySelector('#insulation-options .option-card.selected');
            return selected ? selected.getAttribute('data-value') : null;
        }

        // Новый алгоритм расчета с ориентацией по ширине помещения
        function calculateRoom(roomId, roomName, length, width, insulation) {
            const totalArea = length * width;
            const targetArea = totalArea * 0.9;
            const minArea = totalArea * 0.85;
            const maxArea = totalArea * 1.00;

            // Фильтр моделей по утеплению
            const suitableModels = models.filter(model => {
                if (insulation === 'low' && model.powerM2 >= 200) return true;
                if (insulation === 'medium' && model.powerM2 >= 180 && model.powerM2 <= 200) return true;
                if (insulation === 'high' && model.powerM2 >= 140 && model.powerM2 <= 180) return true;
                return false;
            });

            let bestModel = null;
            let bestSections = 0;
            let bestCoverage = 0;
            let bestDeviation = Infinity;
            let bestOrientation = 'width'; // 'width' или 'length'

            for (const model of suitableModels) {
                // Определяем, какая ориентация лучше - по ширине или по длине
                const orientations = [
                    { type: 'width', sectionWidth: model.width, sectionLength: model.length },
                    { type: 'length', sectionWidth: model.length, sectionLength: model.width }
                ];

                for (const orientation of orientations) {
                    // Проверяем, помещается ли секция по ширине
                    if (orientation.sectionWidth > width) continue;

                    // Рассчитываем количество секций в ряду и количество рядов
                    const sectionsInRow = Math.floor(width / orientation.sectionWidth);
                    const rows = Math.ceil(targetArea / (sectionsInRow * model.area));
                    
                    const sections = sectionsInRow * rows;
                    const coverage = sections * model.area;
                    const totalPower = sections * model.power;
                    
                    // Проверяем мощность
                    if (totalPower > MAX_POWER_PER_CIRCUIT) continue;
                    
                    // Проверяем, что маты физически помещаются в комнату
                    if (rows * orientation.sectionLength > length) continue;
                    
                    const coveragePct = (coverage / totalArea) * 100;
                    const deviation = Math.abs(coveragePct - 90);
                    
                    if (deviation < bestDeviation) {
                        bestDeviation = deviation;
                        bestModel = model;
                        bestSections = sections;
                        bestCoverage = coverage;
                        bestOrientation = orientation.type;
                    }
                }
            }

            if (bestModel) {
                const totalPower = bestSections * bestModel.power;
                const thermostatCount = Math.max(1, Math.ceil(bestCoverage / 20));
                const thermostatPrice = 5000;
                const thermostatTotal = thermostatPrice * thermostatCount;
                const installPrice = bestCoverage * 1000 + thermostatCount * 3000;
                const floorPrice = bestCoverage * 3000;
                const totalCost = installPrice + floorPrice + thermostatTotal;
                
                return {
                    roomId,
                    roomName,
                    length,
                    width,
                    totalArea,
                    model: bestModel,
                    sectionsNeeded: bestSections,
                    coverage: bestCoverage,
                    totalPower,
                    coveragePercentage: (bestCoverage / totalArea) * 100,
                    powerUsage: totalArea * 20,
                    thermostatCount,
                    thermostatPrice,
                    thermostatTotal,
                    installPrice,
                    floorPrice,
                    totalCost,
                    orientation: bestOrientation,
                    success: true
                };
            }

            return { roomId, roomName, length, width, totalArea, success: false };
        }

        // Визуализация с учетом ориентации
        function visualizeLayout(roomResult, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!roomResult || !roomResult.success) {
                container.innerHTML = '<div class="warning">Нет данных для визуализации</div>';
                return;
            }

            const roomLength = roomResult.length;
            const roomWidth = roomResult.width;
            const model = roomResult.model;
            const totalSections = roomResult.sectionsNeeded;
            const orientation = roomResult.orientation;

            // Масштабирование
            const maxWidth = 400;
            const maxHeight = 280;
            const scaleX = maxWidth / roomLength;
            const scaleY = maxHeight / roomWidth;
            const scale = Math.min(scaleX, scaleY);

            // Контур помещения
            const roomElement = document.createElement('div');
            roomElement.className = 'room-outline';
            roomElement.style.width = `${roomLength * scale}px`;
            roomElement.style.height = `${roomWidth * scale}px`;
            roomElement.style.left = '50%';
            roomElement.style.top = '50%';
            roomElement.style.transform = 'translate(-50%, -50%)';
            container.appendChild(roomElement);

            // Определяем размеры секции в зависимости от ориентации
            let sectionWidth, sectionLength;
            if (orientation === 'width') {
                sectionWidth = model.width;
                sectionLength = model.length;
            } else {
                sectionWidth = model.length;
                sectionLength = model.width;
            }

            // Рассчитываем количество секций в ряду и количество рядов
            const sectionsInRow = Math.floor(roomWidth / sectionWidth);
            const rows = Math.ceil(totalSections / sectionsInRow);

            // Рисуем секции
            let sectionCount = 0;
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < sectionsInRow; col++) {
                    if (sectionCount >= totalSections) break;
                    
                    const sectionElement = document.createElement('div');
                    sectionElement.className = 'section';
                    sectionElement.style.width = `${sectionWidth * scale}px`;
                    sectionElement.style.height = `${sectionLength * scale}px`;
                    sectionElement.style.left = `${col * sectionWidth * scale}px`;
                    sectionElement.style.top = `${row * sectionLength * scale}px`;
                    sectionElement.title = `${model.name} (${sectionWidth}м × ${sectionLength}м)`;
                    
                    // Номер секции
                    const sectionNumber = document.createElement('div');
                    sectionNumber.textContent = sectionCount + 1;
                    sectionElement.appendChild(sectionNumber);
                    
                    roomElement.appendChild(sectionElement);
                    sectionCount++;
                }
                if (sectionCount >= totalSections) break;
            }

            // Информация о схеме укладки
            const layoutInfo = document.createElement('div');
            layoutInfo.className = 'layout-info';
            layoutInfo.innerHTML = `
                <strong>Схема укладки:</strong> ${sectionsInRow} × ${rows} (${sectionsInRow} секций в ряду, ${rows} рядов)<br>
                <strong>Ориентация:</strong> ${orientation === 'width' ? 'Ширина модуля вдоль ширины помещения' : 'Модуль повернут на 90°'}<br>
                <strong>Размер секции:</strong> ${sectionWidth}м × ${sectionLength}м
            `;
            container.appendChild(layoutInfo);
        }

        function calculateAllRooms() {
            const insulation = getSelectedInsulation();
            const rooms = document.querySelectorAll('.room-container');
            roomsData = [];
            const errors = [];
            
            if (rooms.length === 0) {
                showError('Добавьте хотя бы одно помещение');
                return;
            }
            
            rooms.forEach(room => {
                const roomId = room.id;
                const roomName = document.getElementById(`${roomId}-name`).value || `Помещение ${roomId}`;
                const length = parseFloat(document.getElementById(`${roomId}-length`).value);
                const width = parseFloat(document.getElementById(`${roomId}-width`).value);
                
                if (!length || !width || length <= 0 || width <= 0) {
                    errors.push(`Заполните корректные размеры для ${roomName}`);
                    return;
                }
                
                const roomResult = calculateRoom(roomId, roomName, length, width, insulation);
                roomsData.push(roomResult);
            });
            
            displayAllResults(roomsData, errors);
        }

        function displayAllResults(roomsData, errors = []) {
            const container = document.getElementById('results-container');
            let html = '';

            if (errors.length) {
                html += `<div class="warning">${errors.join('<br>')}</div>`;
            }

            let totalArea = 0;
            let totalCoverage = 0;
            let totalPower = 0;
            let totalCost = 0;
            let totalThermostats = 0;
            
            roomsData.forEach(room => {
                if (room.success) {
                    totalArea += room.totalArea;
                    totalCoverage += room.coverage;
                    totalPower += room.totalPower;
                    totalCost += room.totalCost;
                    totalThermostats += room.thermostatCount;
                }
            });

            roomsData.forEach((room, index) => {
                if (!room.success) {
                    html += `
                        <div class="room-result">
                            <div class="room-result-header">${room.roomName} - Не найдено подходящей модели</div>
                            <div class="warning" style="margin: 15px;">
                                Для помещения ${room.length}м × ${room.width}м не найдено подходящей модели. Попробуйте изменить размеры помещения или параметры утепления.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const visualizationId = `visualization-${index}`;
                html += `
                    <div class="room-result">
                        <div class="room-result-header">${room.roomName} (${room.length}м × ${room.width}м)</div>
                        <div class="room-result-content">
                            <div class="result-card">
                                <h4>ОПТИМАЛЬНАЯ МОДЕЛЬ: ${room.model.name}</h4>
                                <div class="result-grid">
                                    <div class="result-item"><strong>Мощность на м²:</strong> ${room.model.powerM2} Вт/м²</div>
                                    <div class="result-item"><strong>Мощность секции:</strong> ${room.model.power} Вт</div>
                                    <div class="result-item"><strong>Секций требуется:</strong> ${room.sectionsNeeded} шт.</div>
                                    <div class="result-item"><strong>Покрываемая площадь:</strong> ${room.coverage.toFixed(2)} м²</div>
                                    <div class="result-item"><strong>Общая мощность:</strong> ${room.totalPower} Вт</div>
                                    <div class="result-item"><strong>Размер секции:</strong> ${room.model.width}м × ${room.model.length}м</div>
                                    <div class="result-item"><strong>Ориентация:</strong> ${room.orientation === 'width' ? 'По ширине' : 'По длине'}</div>
                                </div>
                                ${room.totalPower > 2500 ? 
                                    `<div class="power-warning">Внимание: Мощность близка к предельной. Убедитесь в надежности электропроводки.</div>` : ''
                                }
                            </div>
                            <div class="layout-visualization">
                                <div class="visualization-title">Схема укладки</div>
                                <div class="visualization-container" id="${visualizationId}"></div>
                                <div class="coverage-info">
                                    Покрытие: ${room.coveragePercentage.toFixed(1)}% от общей площади помещения
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (roomsData.some(room => room.success)) {
                html += `
                    <div class="total-summary">
                        <h3>ОБЩИЙ ИТОГ ПО ВСЕМУ ЗДАНИЮ</h3>
                        <table class="summary-table">
                            <tr><th>Общая площадь помещений</th><td>${totalArea.toFixed(2)} м²</td></tr>
                            <tr><th>Общая площадь укладки</th><td>${totalCoverage.toFixed(2)} м²</td></tr>
                            <tr><th>Общая мощность системы</th><td>${totalPower} Вт</td></tr>
                            <tr><th>Количество терморегуляторов</th><td>${totalThermostats} шт.</td></tr>
                            <tr><th>Общая стоимость</th><td>${totalCost.toLocaleString('ru-RU')} руб.</td></tr>
                        </table>
                    </div>
                `;
                
                // Показываем кнопку скачивания PDF
                document.getElementById('download-pdf-btn').style.display = 'block';
            }

            container.innerHTML = html;

            // Визуализации
            roomsData.forEach((room, index) => {
                if (room.success) {
                    setTimeout(() => {
                        visualizeLayout(room, `visualization-${index}`);
                    }, 100);
                }
            });
        }

        function showError(message) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<div class="warning">${message}</div>`;
        }

        // Функция для создания PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Заголовок
            doc.setFontSize(20);
            doc.text('Коммерческое предложение', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Расчет системы теплого пола', 105, 22, { align: 'center' });
            
            let yPosition = 35;
            
            // Общая информация
            doc.setFontSize(14);
            doc.text('Общая информация', 14, yPosition);
            yPosition += 10;
            
            const insulation = getSelectedInsulation();
            let insulationText = '';
            if (insulation === 'low') insulationText = 'Низкое утепление (балкон, лоджия, старый дом)';
            else if (insulation === 'medium') insulationText = 'Среднее утепление (городская квартира)';
            else if (insulation === 'high') insulationText = 'Высокое утепление (новостройка, утепленный дом)';
            
            doc.setFontSize(10);
            doc.text(`Уровень утепления: ${insulationText}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Количество помещений: ${roomsData.filter(r => r.success).length}`, 14, yPosition);
            yPosition += 10;
            
            // Данные по помещениям
            roomsData.forEach((room, index) => {
                if (!room.success) return;
                
                // Проверяем, нужно ли добавить новую страницу
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`Помещение: ${room.roomName}`, 14, yPosition);
                yPosition += 7;
                
                doc.setFontSize(10);
                doc.text(`Размеры: ${room.length}м × ${room.width}м`, 14, yPosition);
                yPosition += 5;
                doc.text(`Общая площадь: ${room.totalArea.toFixed(2)} м²`, 14, yPosition);
                yPosition += 5;
                doc.text(`Модель: ${room.model.name}`, 14, yPosition);
                yPosition += 5;
                doc.text(`Количество секций: ${room.sectionsNeeded} шт.`, 14, yPosition);
                yPosition += 5;
                doc.text(`Покрываемая площадь: ${room.coverage.toFixed(2)} м² (${room.coveragePercentage.toFixed(1)}%)`, 14, yPosition);
                yPosition += 5;
                doc.text(`Мощность: ${room.totalPower} Вт`, 14, yPosition);
                yPosition += 5;
                doc.text(`Ориентация: ${room.orientation === 'width' ? 'По ширине' : 'По длине'}`, 14, yPosition);
                yPosition += 5;
                
                // Стоимость
                doc.text(`Стоимость материалов: ${room.floorPrice.toLocaleString('ru-RU')} руб.`, 14, yPosition);
                yPosition += 5;
                doc.text(`Стоимость монтажа: ${room.installPrice.toLocaleString('ru-RU')} руб.`, 14, yPosition);
                yPosition += 5;
                doc.text(`Терморегуляторы: ${room.thermostatCount} шт. × ${room.thermostatPrice.toLocaleString('ru-RU')} руб. = ${room.thermostatTotal.toLocaleString('ru-RU')} руб.`, 14, yPosition);
                yPosition += 5;
                doc.setFont(undefined, 'bold');
                doc.text(`ИТОГО по помещению: ${room.totalCost.toLocaleString('ru-RU')} руб.`, 14, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += 10;
            });
            
            // Общий итог
            if (yPosition > 220) {
                doc.addPage();
                yPosition = 20;
            }
            
            const totalArea = roomsData.filter(r => r.success).reduce((sum, room) => sum + room.totalArea, 0);
            const totalCoverage = roomsData.filter(r => r.success).reduce((sum, room) => sum + room.coverage, 0);
            const totalPower = roomsData.filter(r => r.success).reduce((sum, room) => sum + room.totalPower, 0);
            const totalCost = roomsData.filter(r => r.success).reduce((sum, room) => sum + room.totalCost, 0);
            const totalThermostats = roomsData.filter(r => r.success).reduce((sum, room) => sum + room.thermostatCount, 0);
            
            doc.setFontSize(14);
            doc.text('ОБЩИЙ ИТОГ', 14, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.text(`Общая площадь помещений: ${totalArea.toFixed(2)} м²`, 14, yPosition);
            yPosition += 5;
            doc.text(`Общая площадь укладки: ${totalCoverage.toFixed(2)} м²`, 14, yPosition);
            yPosition += 5;
            doc.text(`Общая мощность системы: ${totalPower} Вт`, 14, yPosition);
            yPosition += 5;
            doc.text(`Количество терморегуляторов: ${totalThermostats} шт.`, 14, yPosition);
            yPosition += 5;
            doc.setFont(undefined, 'bold');
            doc.text(`ОБЩАЯ СТОИМОСТЬ: ${totalCost.toLocaleString('ru-RU')} руб.`, 14, yPosition);
            yPosition += 10;
            
            // Примечания
            doc.setFont(undefined, 'normal');
            doc.text('Примечание: Расчет является предварительным. Для точного подбора обратитесь к специалисту.', 14, yPosition);
            yPosition += 7;
            doc.text('Срок выполнения работ: 5-10 рабочих дней', 14, yPosition);
            yPosition += 7;
            doc.text('Гарантия на оборудование: 5 лет', 14, yPosition);
            yPosition += 7;
            doc.text('Гарантия на монтажные работы: 2 года', 14, yPosition);
            
            // Сохраняем PDF
            doc.save('Расчет_теплого_пола.pdf');
        }
    </script>
</body>
</html>
